<odoo>
    <data>
        <!-- Sale Order Form View -->
        <record id="view_sale_order_form_inherit" model="ir.ui.view">
            <field name="name">sale.order.inherit</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="sale.view_order_form" />
            <field name="type">form</field>
            <field name="arch" type="xml">
                <!-- Custom fields here -->
                <xpath expr="//sheet/div/button[@name='preview_sale_order']" position="replace">
                </xpath>
                <field name="payment_term_id" position="after">
                    <field name="task" string="Task" attrs="{'invisible':[('task', '=', False)]}" invisible="1" />
                </field>
                <xpath expr="//div[@class='oe_button_box']/button[@name='action_view_delivery']/field" position="attributes">
                    <attribute name="string">Picks</attribute>
                </xpath>
                <xpath expr="//div[@class='oe_button_box']" position="inside">
                    <button class="oe_stat_button" type="object" name="open_order_history" icon="fa-usd" modifiers="{}" options="{}" attrs="{'invisible': [('partner_sale_order_count', '=', False)]}">
                        <field string="Order History" name="partner_sale_order_count" widget="statinfo" modifiers="{'readonly':true}" id="sale_order_count" />
                    </button>
                    <button class="oe_stat_button" type="object" name="open_returns" icon="fa-usd" modifiers="{}" options="{}" attrs="{'invisible': [('return_count', 'in', [0,False])]}">
                        <field string="Returns" name="return_count" widget="statinfo" modifiers="{'readonly':true}" id="return_count" />
                    </button>
                </xpath>
                <field name="partner_id" position="after">
                    <field name="order_type" readonly="1" invisible="1" />
                </field>
                <field name="date_order" position="after">
                    <field name="fulfillment_type"/>
                    <span class="o_form_label o_td_label" name="address_name" attrs="{'invisible': [('fulfillment_type', '!=', 'delivery')]}">
                        <b>Delivery Address</b>
                    </span>
                    <div class="o_address_format" attrs="{'invisible': [('fulfillment_type', '!=', 'delivery')]}">
                        <field name="street" placeholder="Street..." class="o_address_street" attrs="{'readonly': [('state', '=', 'done')],'required':[('fulfillment_type','=','delivery')]}"/>
                        <field name="street2" placeholder="Street 2..." class="o_address_street" attrs="{'readonly': [('state', '=', 'done')]}"/>
                        <field name="city" placeholder="City" class="o_address_city" attrs="{'readonly': [('state', '=', 'done')],'required':[('fulfillment_type','=','delivery')]}"/>
                        <field name="state_id" class="o_address_state" placeholder="State" options="{'no_open': True, 'no_quick_create': True}" attrs="{'readonly': [('state', '=', 'done')],'required':[('fulfillment_type','=','delivery')]}" context="{'country_id': country_id, 'default_country_id': country_id, 'zip': zip}"/>
                        <field name="zip" placeholder="ZIP" class="o_address_zip" attrs="{'readonly': [('state', '=', 'done')],'required':[('fulfillment_type','=','delivery')]}"/>
                        <field name="country_id" placeholder="Country" class="o_address_country" options="{&quot;no_open&quot;: True, &quot;no_create&quot;: True}" attrs="{'readonly': [('state', '=', 'done')],'required':[('fulfillment_type','=','delivery')]}"/>
                    </div>
                </field>
                <!-- Custom Add Product Button -->
                <field name="order_line" position="after">
                    <button name="open_catalog" string="Add a Product" class="btn-primary oe_edit_only" type="object" />
                    <span style="margin: 5px;"/>
                    <button name="open_notes" string="Notes" class="btn-primary oe_edit_only" type="object" />
                </field>
                <xpath expr="//control" position="replace"></xpath>
                <field name="validity_date" position="replace">
                    <field name="validity_date" invisible="1"></field>
                </field>
                <field name="payment_term_id" position="replace">
                    <field name="payment_term_id" invisible="1"></field>
                </field>
                <field name="date_order" position="attributes">
                    <attribute name="invisible">1</attribute>
                </field>
                <field name="pricelist_id" position="attributes">
                    <attribute name="invisible">1</attribute>
                </field>
                <xpath expr="//label[@for='pricelist_id']" position="replace"/>
                <!-- <xpath expr="//tree/field[@name='product_id']" position="replace">
                    <field name="order_type" invisible="1"></field>
                    <field name="product_id" attrs="{'readonly': [('product_updatable', '=', False)],'required': [('display_type', '=', False)],}" options="{'no_open': True,'no_create':True}" force_save="1" context="{'partner_id': parent.partner_id,'quantity': product_uom_qty,'pricelist': parent.pricelist_id,'uom':product_uom,'company_id': parent.company_id,'default_lst_price': price_unit,'default_description_sale': name}" domain="[('sale_ok', '=', True), '|', ('company_id', '=', False), ('company_id', '=', company_id),('thc_type','in',['medical','adult','merch'] if order_type == 'none' else [order_type, 'merch']),('type','!=','service')]" widget="product_configurator" />
                </xpath>
                <xpath expr="//tree/field[@name='product_uom_qty']" position="attributes">
                    <attribute name="widget">qty_widget</attribute>
                </xpath> -->
                <!-- <xpath expr="//tree/field[@name='sequence']" position="replace">
                    <field name="sequence" invisible="1"/>
                </xpath>
                <xpath expr="//tree/field[@name='product_uom']" position="replace">
                    <field name="product_uom" invisible="1"/>
                </xpath>
                <xpath expr="//tree/field[@name='name']" position="replace">
                    <field name="name" invisible="1"/>
                </xpath>
                <xpath expr="//tree/field[@name='tax_id']" position="before">
                    <field name="lot_id"/>
                    <field name="discount_ids" widget="many2many_tags" options="{'color_field': 'color'}"/>
                </xpath>
                <xpath expr="//tree" position="attributes">
                    <attribute name="create">false</attribute>
                    <attribute name="editable"/>
                    <attribute name="edit">false</attribute>
                </xpath> -->
                <!-- Sale Line Updates -->
                <xpath expr="//tree" position="replace">
                    <tree create="0" edit="false" editable="">
                        <!-- Invisible fields -->
                        <field name="display_type" invisible="1"/>
                        <field name="invoice_status" invisible="1"/>
                        <field name="qty_invoiced" invisible="1"/>
                        <field name="product_uom" invisible="1"/>
                        <field name="price_tax" invisible="1"/>
                        <!-- Visible fields -->
                        <field name="product_categ_id"/>
                        <field name="product_id"/>
                        <field name="lot_id" string="Metrc #"/>
                        <field name="thc_type" string="Type"/>
                        <field name="product_uom_qty" decoration-info="(not display_type and invoice_status == 'to invoice')" decoration-bf="(not display_type and invoice_status == 'to invoice')" context="{'partner_id': parent.partner_id,'quantity': product_uom_qty,'pricelist': parent.pricelist_id,'uom': product_uom,'company_id': parent.company_id}"/>
                        <field name="price_unit" attrs="{'readonly': [('qty_invoiced', '&gt;', 0)]}"/>
                        <field name="discount_ids" widget="many2many_tags" options="{'color_field': 'color'}"/>
                        <field name="tax_id" widget="many2many_tags" options="{'no_create': True}" domain="[('type_tax_use','=','sale'),('company_id','=',parent.company_id)]" attrs="{'readonly': [('qty_invoiced', '&gt;', 0)]}" optional="show"/>
                        <field name="price_subtotal" widget="monetary" groups="account.group_show_line_subtotals_tax_excluded"/>
                    </tree>
                </xpath>

                <xpath expr="(//header/button[@name='action_confirm'])[2]" position="replace">
                </xpath>
                <xpath expr="(//header/button[@name='action_confirm'])[1]" position="attributes">
                    <attribute name="attrs">{'invisible': [('state', 'in', ['sale','done','cancel'])]}</attribute>
                </xpath>
                <xpath expr="//header/button[@name='action_cancel']" position="before">
                    <button name="create_return" type="object" string="Return" class="btn btn-secondary" attrs="{'invisible':[('state', '!=', 'done')]}">Return</button>
                </xpath>
                <xpath expr="//header/button[@name='action_cancel']" position="attributes">
                    <attribute name="string">Abandon Cart</attribute>
                    <attribute name="name">show_cancel_reason_wizard</attribute>
                </xpath>
                <xpath expr="(//header/button[@name='action_quotation_send'])[4]" position="attributes">
                    <attribute name="invisible">1</attribute>
                </xpath>
                <!-- Invoice buttons -->
                <xpath expr="(//header/button)[3]" position="attributes">
                    <attribute name="invisible">1</attribute>
                </xpath>
                <xpath expr="(//header/button)[4]" position="attributes">
                    <attribute name="invisible">1</attribute>
                </xpath>
                <!-- Not sure about this next one -->
                <xpath expr="(//header/field)[2]" position="attributes">
                    <attribute name="invisible">1</attribute>
                </xpath>
                <xpath expr="(//header/button)[3]" position="replace">
                </xpath>
                <xpath expr="(//header/button)[4]" position="replace">
                </xpath>
                <xpath expr="//div[@name='button_box']" position="after">
                    <field name="partner_image" widget="image" class="oe_avatar" options="{'preview_image': 'image_128'}"/>
                </xpath>
                <field name="state" position="before">
                    <field name="threshold1" invisible="1"/>
                    <field name="threshold2" invisible="1"/>
                    <field name="threshold3" invisible="1"/>
                    <field name="timer_start" widget="so_timer" attrs="{'invisible':[('state', '!=', 'draft')]}"/>
                </field>
                <!-- Tax explanation -->
                <field name="amount_untaxed" position="after">
                    <field name="amount_by_group" widget="tax-group-custom-field" nolabel="1" colspan="2" attrs="{'invisible': [('amount_tax', '=', 0)]}"/>
                </field>
                <field name="amount_tax" position="attributes">
                    <attribute name="string">Total Taxes</attribute>
                </field>
            </field>
        </record>
        <!-- Sales Order History Kanban View -->
        <record model="ir.ui.view" id="view_sale_order_history_kanban">
            <field name="name">sale.order.history.kanban</field>
            <field name="model">sale.order</field>
            <field name="arch" type="xml">
                <kanban class="o_kanban_mobile" sample="1" create="false" edit="false">
                    <field name="name" />
                    <field name="partner_id" />
                    <field name="amount_total" />
                    <field name="date_order" />
                    <field name="state" />
                    <field name="currency_id" />
                    <field name="order_line" />
                    <field name="amount_by_group"/>
                    <!-- <field name="activity_state"/>
                        
                    <progressbar field="activity_state" colors='{"planned": "success", "today": "warning", "overdue": "danger"}'/> -->
                    <templates>
                        <t t-name="kanban-box">
                            <div t-attf-class="oe_kanban_card oe_kanban_global_click" style="width: 50%;">
                                <div class="o_kanban_record_top mb16">
                                    <div class="o_kanban_record_headings mt4">
                                        <strong class="o_kanban_record_title">
                                            <span>
                                                <t t-esc="record.name.value" />
                                            </span>
                                        </strong>
                                        <br />
                                        <span>
                                            Order Ref #:
                                            <field name="pos_terminal_id"/>
                                        </span>
                                        <br />
                                        <span>
                                            Session:
                                            <field name="session_id"/>
                                        </span>
                                        <br />
                                        <span>
                                            Date:
                                            <field name="date_order" widget="date" />
                                        </span>
                                        <br />
                                        <span>
                                            Payment Method:
                                            <field name="payment_method"/>
                                        </span>
                                    </div>
                                    <div class="o_kanban_record_headings mt4">
                                        <br />
                                        <br />
                                        <span>
                                            Salesperson:
                                            <field name="user_id"/>
                                        </span>
                                        <br />
                                        <span>
                                            Fulfillment:
                                            <span><field name="fulfillment_type"/></span>
                                        </span>
                                        <br />
                                        <span>
                                            Cashier:
                                            <field name="cashier_partner_id"/>
                                        </span>
                                    </div>
                                    <field name="state" widget="label_selection" options="{'classes': {'draft': 'default', 'cancel': 'default', 'done': 'success'}}" />
                                </div>
                                <hr style="border-top: 2px solid #bbb; flex-grow:100" />
                                <div class="o_list_view" style="height: auto;">
                                    <div class="table-responsive">
                                        <table class="o_list_table table table-sm table-hover table-striped o_list_table_ungrouped o_section_and_note_list_view" style="table-layout: fixed;">
                                            <thead>
                                                <tr>
                                                    <th data-name="product_categ_id" class="o_product_configurator_cell o_column_sortable" tab-index="-1" style="width: 250px;">
                                                        Category
                                                        <span class="o_resize" />
                                                    </th>
                                                    <th data-name="product_id" class="o_product_configurator_cell o_column_sortable" tab-index="-1" style="width: 250px;">
                                                        Product
                                                        <span class="o_resize" />
                                                    </th>
                                                    <th data-name="thc_type" class="o_product_configurator_cell o_column_sortable" tab-index="-1" style="width: 250px;">
                                                        Type
                                                        <span class="o_resize" />
                                                    </th>
                                                    <th data-name="product_uom_qty" tabindex="-1" class="o_column_sortable" style="width: 95px;">
                                                        Quantity
                                                        <span class="o_resize" />
                                                    </th>
                                                    <th data-name="price_unit" tabindex="-1" class="o_column_sortable " aria-sort="ascending" data-original-title="" title="" style="width: 96px;">
                                                        Unit Price
                                                        <span class="o_resize" />
                                                    </th>
                                                    <th data-name="discount_ids" class="o_product_configurator_cell o_column_sortable" tab-index="-1" style="width: 250px;">
                                                        Discounts
                                                        <span class="o_resize" />
                                                    </th>
                                                    <th data-name="price_subtotal" class="o_monetary_cell o_column_sortable " tabindex="-1" data-original-title="" title="" style="width: 110px;">
                                                        Subtotal
                                                        <span class="o_resize" />
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <t t-foreach="record.order_line.raw_value" t-as="o">
                                                    <tr>
                                                        <td>
                                                            <t t-if="o.product_categ_id">
                                                                <t t-esc="o.product_categ_id[1]"/>
                                                            </t>
                                                        </td>
                                                        <td>
                                                            <t t-esc="o.name" />
                                                        </td>
                                                        <td>
                                                            <t t-esc="o.thc_type"/>
                                                        </td>
                                                        <td>
                                                            <t t-esc="o.product_uom_qty" />
                                                        </td>
                                                        <td>
                                                            <t t-set="price" t-value="window.parseFloat(o.price_unit).toFixed(2)" />
                                                            $
                                                            <t t-esc="price" />
                                                        </td>
                                                        <!-- <td>0</td>
                                                        <td>0</td>
                                                        <td>0</td> -->
                                                        <td>
                                                            <t t-esc="o.discount_ids"/>
                                                        </td>
                                                        <td>
                                                            <t t-set="subtotal" t-value="window.parseFloat(o.price_subtotal).toFixed(2)" />
                                                            $
                                                            <t t-esc="subtotal" />
                                                        </td>
                                                        <!--<t t-esc="o.many2onefield[1]"/>-->
                                                    </tr>
                                                </t>
                                            </tbody>
                                            <!-- <tfoot></tfoot> -->
                                        </table>
                                    </div>
                                </div>
                                <div class="o_kanban_record_bottom">
                                    <div class="oe_kanban_bottom_left" style="align-self: flex-end;">
                                        <strong>
                                            <span><field name="fulfillment_type"/></span>
                                        </strong>
                                    </div>
                                    <div class="oe_kanban_bottom_right">
                                        <strong>
                                            <table>
                                                <tbody>
                                                    <tr>
                                                        <td class="text-nowrap" style="padding-right: 20px;">Untaxed Amount:</td>
                                                        <td>
                                                            <field name="amount_untaxed" widget="monetary" />
                                                        </td>
                                                    </tr>
                                                    <t t-if="record.amount_by_group">
                                                        <t t-foreach="record.amount_by_group.raw_value" t-as="line">
                                                          <tr>
                                                            <td class="text-nowrap" style="padding-right: 20px;">
                                                                <span class="o_form_label" t-esc="line[0]"/>
                                                            </td>
                                                            <td class="oe_tax_group_editable" t-att-data-tax-group-id="line[6]">
                                                                <span class="oe_tax_group_amount_value">
                                                                    <t t-esc="line[3]"/>
                                                                </span>
                                                            </td>
                                                          </tr>
                                                        </t>
                                                    </t>
                                                    <tr>
                                                        <td class="text-nowrap" style="padding-right: 20px;">Total Tax:</td>
                                                        <td>
                                                            <field name="amount_tax" widget="monetary"/>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="text-nowrap" style="padding-right: 20px;">Total:</td>
                                                        <td>
                                                            <field name="amount_total" widget="monetary" />
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </strong>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </templates>
                </kanban>
            </field>
        </record>
        <!-- Order History List View -->
        <record model="ir.ui.view" id="view_sale_order_history_list">
            <field name="name">sale.order.history.list</field>
            <field name="model">sale.order</field>
            <field name="priority">0</field>
            <field name="arch" type="xml">
                <tree create="0" edit="0">
                    <field name="pos_terminal_id" string="Order Ref"/>
                    <field name="session_id" string="Session"/>
                    <field name="date_order"/>

                    <field name="partner_id" string="Customer"/>
                    <field name="user_id" string="Salesperson"/>
                    <field name="fulfillment_partner_id" string="Fulfillment"/>
                    <field name="cashier_partner_id" string="POS User"/>
                    <field name="fulfillment_type" string="Fulfillment Method"/>
                    <field name="payment_method" string="Payment Method"/>
                    <field name="amount_total" string="Total"/>
                    <field name="state" string="Status" widget="badge" decoration-success="state == 'sale' or state == 'done'" decoration-info="state == 'draft' or state == 'sent'"/>
                </tree>
            </field>
        </record>
        <!-- Search View for order history -->
        <record id="view_sale_order_history_filter" model="ir.ui.view">
            <field name="name">sale.order.history.search</field>
            <field name="model">sale.order</field>
            <field name="arch" type="xml">
                <search string="Search Order History">
                    <field name="partner_id" operator="child_of"/>
                    <filter string="Paid" name="paid" domain="[('state', '=', 'done')]"/>
                    <filter string="Canceled" name="canceled" domain="[('state', '=', 'canceled')]"/>
                    <filter string="Saved" name="saved" domain="[('state', '=', 'save')]"/>
                    <!-- <group expand="0" name="group_by" string="Group By">
                        <!- <filter name="salesperson" string="Salesperson" domain="[]" context="{'group_by' : 'user_id'}" />
                        <filter name="group_company" string="Company" context="{'group_by': 'parent_id'}"/>
                        <filter name="group_country" string="Country" context="{'group_by': 'country_id'}"/> ->
                    </group> -->
                </search>
            </field>
        </record>
        <!-- Action to open order history -->
        <record id="order_history" model="ir.actions.act_window">
            <field name="name">Order History</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">sale.order</field>
            <field name="view_mode">tree,form</field>
            <field name="search_view_id" ref="lume_sales.view_sale_order_history_filter"/>
            <field name="view_id" ref="lume_sales.view_sale_order_history_list" />
            <field name="context">{'search_default_partner_id': active_id, 'default_partner_id': active_id}</field>
            <field name="domain">[('state', 'not in', ('draft', 'sent')),('partner_id','=',active_id)]</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    No orders have been completed for this customer!
                </p>
                <p>
                    Once a sale is completed for this customer, you will be able to see details about it here!
                </p>
            </field>
        </record>
    </data>
</odoo>